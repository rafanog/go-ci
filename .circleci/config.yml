version: 2
jobs:
  build:
    machine: true
      
    steps:
      - checkout
      - run: 
          name: Install dependencies
          command: go get -d
      
      - run:
          name: Prepare background server's credentials
          command: |
            echo "AUTH0_DOMAIN=$domain" >> .env
            echo "AUTH0_AUDIENCE=$audience" >> .env
      
      - run:
          name: Execute background server
          command: go run main.go
          background: true
      
      - run: sleep 10
      
      - run:
          name: Prepare unitary tests credentials
          command: |
            cd test
            echo "AUTH0_DOMAIN=$domain" >> .env
            echo "AUTH0_AUDIENCE=$audience" >> .env
            echo "AUTH0_CLIENT_ID_1=$id1" >> .env
            echo "AUTH0_CLIENT_SECRET_1=$secret1" >> .env
            echo "AUTH0_CLIENT_ID_2=$id2" >> .env
            echo "AUTH0_CLIENT_SECRET_2=$secret2" >> .env
            echo "AUTH0_CLIENT_ID_3=$id3" >> .env
            echo "AUTH0_CLIENT_SECRET_3=$secret3" >> .env
            echo "AUTH0_CLIENT_ID_4=$id4" >> .env
            echo "AUTH0_CLIENT_SECRET_4=$secret4" >> .env
            echo "API_URL=http://localhost:3010" >> .env
          
      - run:
          name: Prepare and execute tests
          command: | 
            cd test
            node -v
            npm install && npm test
          
